{% extends 'base.html' %}

{% block content %}


<h2>ðŸ“… Event Dashboard</h2>

{% if request.session.role == 'EventManager' %}
<a href="{% url 'event_create' %}" class="btn btn-sm btn-success mb-3">+ Create New Event</a>
<a href="{% url 'event_analytics' %}" class="btn btn-sm btn-success mb-3 ">ðŸ“Š View Analytics</a>
{% elif request.session.role == 'Attendee' %}
<a class="nav-link" href="{% url 'attendee_profile' %}">My Profile</a>
{% endif %}

<hr>

<h3>ðŸŸ¢ Upcoming Events</h3>
{% if upcoming_events %}
<ul>
  {% for event in upcoming_events %}
  <li>
    <strong>{{ event.title }}</strong> - {{ event.date|date:"D, M d Y H:i" }}<br>
    {{ event.description|truncatechars:30 }}<br>
    ðŸ“… Event in: <span class="countdown" data-event-time="{{ event.date|date:'c' }}"></span><br>
    <a href="{% url 'event_detail' event.id %}" class="btn  btn-secondary active">View Details</a>


    {% if request.session.role == 'Attendee' %}
    {% if event.max_capacity %}
        {% if event.is_full %}
            <a class="btn btn-sm btn-danger mt-2 disabled">Full</a>
        {% else %}
            <a href="{% url 'event_register' event.id %}" class="btn  btn-warning ">
                {{ event.seats_left }} Seats Left - Register
            </a>
        {% endif %}
      {% endif %}
    <a href="{% url 'event_register' event.id %}" class="btn  btn-success active">Register</a>

    {% endif %}

    {% if request.session.role == 'EventManager' %}
    <a href="{% url 'event_delete' event.id %}" class="btn  btn-danger active">Delete</a>
    <a href="{% url 'export_event_csv' event.id %}" class="btn  btn-info active">Download Attendes List</a>

    {% endif %}
  </li>
  {% endfor %}
</ul>
{% else %}
<p><em>No upcoming events.</em></p>
{% endif %}

<hr>

<h3>ðŸ”´ Past Events</h3>
{% if past_events %}
<ul>
  {% for event in past_events %}
  <li>
    <strong>{{ event.title }}</strong> - {{ event.date|date:"D, M d Y H:i" }}<br>
    {{ event.description|truncatechars:50 }}<br>
    <a href="{% url 'event_detail' event.id %}" class="btn btn-sm btn-secondary">View Details</a>

    {% if request.session.role == 'EventManager' %}
    <a href="{% url 'event_delete' event.id %}" class="btn btn-sm btn-danger">Delete</a>
    <a href="{% url 'export_event_csv' event.id %}" class="btn btn-sm btn-info">Download Attendes List</a>

    {% endif %}
  </li>
  {% endfor %}
</ul>
{% else %}
<p><em>No past events yet.</em></p>
{% endif %}

<!-- ðŸ‘‡ Live Countdown Script -->
<script>
  function updateCountdowns() {
    const countdownElements = document.querySelectorAll(".countdown");

    for (let el of countdownElements) {
      const eventTime = new Date(el.getAttribute("data-event-time"));
      const now = new Date();
      const diff = eventTime - now;

      if (diff <= 0) {
        el.innerText = "Event started!";
        continue;
      }

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((diff / (1000 * 60)) % 60);
      const seconds = Math.floor((diff / 1000) % 60);

      el.innerText = `${days}d ${String(hours).padStart(2, '0')}h:${String(minutes).padStart(2, '0')}m:${String(seconds).padStart(2, '0')}s`;
    }
  }

  updateCountdowns();
  setInterval(updateCountdowns, 1000);
</script>

{% endblock %}